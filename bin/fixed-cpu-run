#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

if [[ "$@" == "" || "$@" == *-h* || "$@" == *--help* ]]; then
  cat<<EOF
fixed-cpu-run - Temporarily set CPU frequency governor to performance and disable CPU boost
                Intended for reproducible benchmarks

Usage:
  fixed-cpu-run <command>
  fixed-cpu-run -h | --help

Options:
  -h --help       Show this help text.
EOF
  exit 64
fi

governor="$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)"
boost="$(cat /sys/devices/system/cpu/cpufreq/boost)"

cleanup () {
  sudo sh << EOF
set -o errexit
set -o nounset
set -o pipefail
cpupower frequency-set -g "$governor" >/dev/null
echo "$boost" > /sys/devices/system/cpu/cpufreq/boost
EOF
}

trap cleanup EXIT

sudo sh << "EOF"
set -o errexit
set -o nounset
set -o pipefail
cpupower frequency-set -g performance >/dev/null
echo 0 > /sys/devices/system/cpu/cpufreq/boost
EOF

"$@"
